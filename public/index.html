<!doctype html>
<html lang="en">

<head>
  <title>Magic: the Gathering Club</title>
  <meta charset="utf-8">
  <link href="/css/style.css" rel="stylesheet" type="text/css">
</head>

<body>
  <h1>WPI Magic: the Gathering Club Application</h1>

  <main>
    <button id="switchModeButton">View Members</button>
    <button id="loginScreenButton" onclick="location.href='/login.html';">Login</button>

    <div id="application">
      <h2>Stop! Who would cross the Bridge of Death must answer me these questions <del>three</del> five, 'ere the other side they see.</h2>
      <form action="">
        <div class="input">
          <label for="firstname" class="label">
            What is your first name?</label>
          <input type="text" id="firstname">
        </div>
        <div class="input">
          <label for="lastname" class="label">
            What is your last name?</label>
          <input type="text" id="lastname">
        </div>
        <div class="input">
          <label for="major" class="label">
            What is your major?</label>
          <input type="text" id="major">
        </div>

        <p id="errorBox">Please respond to all questions and ensure you have entered a valid year</p>

        <div id="submitButton">
          <button>Submit Application</button>
        </div>
      </form>
    </div>

    <div id="updateApplication">
      <h2>Update Information</h2>
      <form action="">
        <div class="input">
          <label for="updatefirstName" class="label">
            What is your first name?</label>
          <input type="text" id="updatefirstName">
        </div>
        <div class="input">
          <label for="updatelastName" class="label">
            What is your last name?</label>
          <input type="text" id="updatelastName">
        </div>
        <div class="input">
          <label for="updateMajor" class="label">
            What is your major?</label>
          <input type="text" id="updateMajor">
        </div>
        <div class="input">
          <label for="uuid" class=label>
            UUID (read-only): </label>
          <input type="text" id="uuid" readonly>
        </div>

        <p id="updateErrorBox">Please respond to all questions and ensure you have entered a valid year</p>

        <div id="updateButtons">
          <button id="cancelButton">Cancel Update</button>
          <button id="updateButton">Submit Update</button>
        </div>
      </form>
    </div>

    <div id="confirmation">
      <h2>Your Application Has Been Received</h2>
      <button id="newApplicationButton">Submit Another Application</button>
    </div>

    <div id="memberTableDiv">
      <h2>Members</h2>
      <table id="memberTable"></table>
    </div>

    <div id="loginScreen">
      <h2>Login</h2>
      <form action="">
        <div class="input">
          <label for="username" class="label">Username</label>
          <input type="text" id="username">
          <label for="password" class="label">Password</label>
          <input type="text" id="password">
        </div>

        <p id="loginErrorBox">Incorrect username or password</p>

        <button id="submitLoginButton">Submit Login</button>
      </form>
    </div>

  </main>
</body>

<script>
  const addMember = function(e) {
    e.preventDefault();

    const newMember = {
      firstname: document.getElementById("firstname").value,
      lastname: document.getElementById("lastname").value,
      major: document.getElementById("major").value
    };
    if (!validate(newMember.firstname, newMember.lastname, newMember.major)) {
      document.getElementById("errorBox").style.display = "block";
      return false;
    }
    document.getElementById("errorBox").style.display = "none";

    const body = JSON.stringify(newMember);
    fetch("/submit", {
      method: "POST",
      body
      headers: { 'Content-Type': 'application/json' }
    }).then(function(response) {
      document.getElementById("confirmation").style.display = "flex";
      document.getElementById("application").style.display = "none";
      clear();
    });
    return false;
  };

  const updateMember = function(e) {
    e.preventDefault();

    const updatedMember = {
      firstname: document.getElementById("updatefirstName").value,
      lastname: document.getElementById("updatelastName").value,
      major: document.getElementById("updateMajor").value,
      uuid: document.getElementById("uuid").value
    };

    if (!validate(updatedMember.firstname, updatedMember.lastname, updatedMember.major)) {
      document.getElementById("updateErrorBox").style.display = "block";
      return false;
    }
    document.getElementById("updateErrorBox").style.display = "none";

    const body = JSON.stringify(updatedMember);
    fetch("/update", {
      method: "POST",
      body
      headers: { 'Content-Type': 'application/json' }
    }).then(function() {
      showMemberTable();
    });
    return false;
  };

  const validate = function(fName, lName, major) {
    if (fName === "" || lName === "" || major === "") return false;
    else return true;
  }

  const deleteMember = function(index) {
    const member = JSON.parse(decodeURIComponent(document.getElementById(`deleteMemberButton-${index}`).dataset.string));
    const id = member.uuid;
    console.log("Deleting ID: " + id);
    const memberNum = {
      uuid: id
    };

    const body = JSON.stringify(memberNum);
    fetch("/delete", {
      method: "POST",
      body
      headers: { 'Content-Type': 'application/json' }
    });
    getMembers();
  };

  const getMembers = async function() {
    const resp = await fetch("/getdata", {
      method: "GET"
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await resp.json();
    const memberList = data.data;

    let table = document.getElementById("memberTable");
    table.innerHTML = "<tr>\n" +
      "<th>First Name</th>\n" +
      "<th>Last Name</th>\n" +
      "<th>Major</th>\n" +
      "<th>Update</th>\n" +
      "<th>Delete</th>\n" +
      "</tr>";

    for (let i = 0; i < memberList.length; i++) {
      const member = memberList[i];
      const str = JSON.stringify(memberList[i]);
      table.innerHTML += "<tr>\n" +
        `<td> ${member.firstname} </td>\n` +
        `<td> ${member.lastname} </td>\n` +
        `<td> ${member.major} </td>\n` +
        `<td> <button id="updateMemberButton-${i}" style="font-size: 1vw"` +
        ` onclick="showUpdate(${i})" data-string=` +
        encodeURIComponent(str) + `>Update</button> </td>\n` +
        `<td> <button id="deleteMemberButton-${i}" style="font-size: 1vw"` +
        ` onclick="deleteMember(${i})" data-string=` +
        encodeURIComponent(str) + `>Delete</button> </td>\n` +
        "</tr>";
    }
    return false;
  };

  const submitLogin = function() {
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;
    const eBox = document.getElementById("loginErrorBox");

    if (username === "" || password === "") {
      eBox.innerHTML = "Please enter both a username and a password"
      eBox.style.display = "block"
    } else {
      eBox.style.display = "none"
    }

    let loginData = {
      username: username,
      password: password
    }

    body = JSON.stringify(loginData)

    fetch('/login', {
      method: 'POST',
      body
      headers: { 'Content-Type': 'application/json' }
    }).then(function(response) {
      console.log(response)
    })
    return false;
  };

  const hideAll = function() {
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("memberTableDiv").style.display = "none";
    document.getElementById("application").style.display = "none";
    document.getElementById("updateApplication").style.display = "none";
    document.getElementById("confirmation").style.display = "none";
    document.getElementById("errorBox").style.display = "none";
    document.getElementById("updateErrorBox").style.display = "none";
    document.getElementById("loginScreenButton").style.display = "none";
    document.getElementById("switchModeButton").style.display = "none";
  };

  const clear = function() {
    document.getElementById("firstname").value = "";
    document.getElementById("lastname").value = "";
    document.getElementById("major").value = "";
    return false;
  };

  const showLogin = function() {
    document.getElementById("loginScreen").style.display = "block";
    document.getElementById("memberTableDiv").style.display = "none";
    document.getElementById("application").style.display = "none";
    document.getElementById("updateApplication").style.display = "none";
    document.getElementById("confirmation").style.display = "none";
    document.getElementById("errorBox").style.display = "none";
    document.getElementById("updateErrorBox").style.display = "none";
    document.getElementById("loginScreenButton").style.display = "none";

  };

  const showApplication = function() {
    document.getElementById("errorBox").style.display = "none";
    document.getElementById("updateErrorBox").style.display = "none";
    document.getElementById("memberTableDiv").style.display = "none";
    document.getElementById("updateApplication").style.display = "none";
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("confirmation").style.display = "none";
    document.getElementById("application").style.display = "block";
    document.getElementById("loginScreenButton").style.display = "block";

    document.getElementById("switchModeButton").innerHTML = "View Members";
    document.getElementById("switchModeButton").onclick = showMemberTable;
    document.getElementById("switchModeButton").style.display = "block";
    clear();
    return false;
  };

  const showMemberTable = function() {
    document.getElementById("memberTableDiv").style.display = "flex";
    document.getElementById("application").style.display = "none";
    document.getElementById("updateApplication").style.display = "none";
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("confirmation").style.display = "none";
    document.getElementById("errorBox").style.display = "none";
    document.getElementById("updateErrorBox").style.display = "none";
    document.getElementById("loginScreenButton").style.display = "block";

    document.getElementById("switchModeButton").innerHTML = "New Application";
    document.getElementById("switchModeButton").onclick = showApplication;
    document.getElementById("switchModeButton").style.display = "block";
    getMembers();
    return false;
  };

  const showUpdate = function(index) {
    const member = JSON.parse(decodeURIComponent(document.getElementById(`updateMemberButton-${index}`).dataset.string));

    document.getElementById("memberTableDiv").style.display = "none";
    document.getElementById("updateApplication").style.display = "block";
    document.getElementById("application").style.display = "none";
    document.getElementById("switchModeButton").style.display = "none";
    document.getElementById("loginScreenButton").style.display = "block";
    document.getElementById("errorBox").style.display = "none";
    document.getElementById("updateErrorBox").style.display = "none";
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("confirmation").style.display = "none";

    document.getElementById("updateButton").dataset.index = index;
    document.getElementById("updatefirstName").value = member.firstname;
    document.getElementById("updatelastName").value = member.lastname;
    document.getElementById("updateMajor").value = member.major;
    document.getElementById("uuid").value = member.uuid;
    return false;
  };

  window.onload = function() {
    const submitButton = document.getElementById("submitButton");
    submitButton.onclick = addMember;
    let switchModeButton = document.getElementById("switchModeButton");
    switchModeButton.innerHTML = "View Members";
    switchModeButton.onclick = showMemberTable;
    switchModeButton.style.display = "block";
    const cancelButton = document.getElementById("cancelButton");
    cancelButton.onclick = showMemberTable;
    const updateButton = document.getElementById("updateButton");
    updateButton.onclick = updateMember;
    const newApplicationButton = document.getElementById("newApplicationButton");
    newApplicationButton.onclick = showApplication;
    const loginScreenButton = document.getElementById("loginScreenButton");
    loginScreenButton.onclick = showLogin;
    const submitLoginButton = document.getElementById("submitLoginButton");
    submitLoginButton.onclick = submitLogin;

    document.getElementById("application").style.display = "none";
    document.getElementById("updateApplication").style.display = "none";
    document.getElementById("confirmation").style.display = "none";
    document.getElementById("memberTableDiv").style.display = "none";
    document.getElementById("loginScreenButton").style.display = "none";
    document.getElementById("errorBox").style.display = "none";
    document.getElementById("updateErrorBox").style.display = "none";
    document.getElementById("loginScreen").style.display = "block";
    document.getElementById("loginErrorBox").style.display = "none";
  };
</script>

</html>
